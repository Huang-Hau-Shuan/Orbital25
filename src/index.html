<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SimuNUS</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      }

      #unity-container,
      #desktop-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
      }

      #desktop-container {
        display: none;
        z-index: 10;
        padding: 5vh 5vw;
        box-sizing: border-box;
      }

      #desktop-container webview {
        width: 100%;
        height: 100%;
        border: 2px solid #888;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      }

      #desktop-container iframe {
        width: 100%;
        height: 100%;
        border: 2px solid #888;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>

  <body>
    <!-- Unity WebGL Game -->
    <!-- <iframe id="unity-container" src="" allowpopups tabindex="-1"></iframe> -->

    <!-- Simulated Desktop (hidden until triggered) -->
    <div id="desktop-container">
      <iframe
        id="desktop-webview"
        src="desktop/index.html"
        allowpopups
      ></iframe>
    </div>

    <script>
      if (window.SimuNUS_API === undefined) {
        console.error("SimuNUS API Undefined");
      }

      const create_view = (_tag, _id, _src, parent, _preload = null) => {
        const view = document.createElement(_tag);
        view.id = _id;
        view.src = _src;
        view.setAttribute("allowpopups", "");
        view.tabIndex = -1;
        if (_tag == "webview" && _preload) {
          view.setAttribute("sandbox", "false");
          view.setAttribute("preload", _preload);
        }
        parent.appendChild(view);
        return view;
      };
      const desktop_container = document.getElementById("desktop-container");
      const desktop_view = create_view(
        window.SimuNUS_API.desktop_embedded_mode,
        "desktop-webview",
        window.SimuNUS_API.simulated_laptop_path + "/index.html",
        desktop_container,
        "preload.js"
      );
      const unity_container = create_view(
        window.SimuNUS_API.unity_embedded_mode,
        "unity-container",
        window.SimuNUS_API.unity_serve_origin,
        document.body,
        "unityPreload.js"
      );

      // Close desktop when user clicks outside its webview
      desktop_container.addEventListener("mousedown", (e) => {
        const webview = document.getElementById("desktop-webview");
        if (!webview.contains(e.target)) {
          hideSimDesktop();
        }
      });

      //Register Message handler
      const msg_forward_functions = {
        main: window.SimuNUS_API.sendMessage,
        unity: (channel, data) =>
          sendTo(
            unity_container,
            channel,
            data,
            window.SimuNUS_API.unity_serve_origin
          ),
        laptop: (channel, data) => sendTo(desktop_view, channel, data),
      };
      const msg_forward_channels = {};
      for (const source in msg_forward_functions) {
        msg_forward_channels[source] = [];
      }
      const msg_callback = {
        hideSim: hideSimDesktop,
        showSim: showSimDesktop,
        register_message_handler: (msg) => {
          const source = msg.source;
          const channel = msg.channel;
          if (source in msg_forward_channels) {
            msg_forward_channels[source].push(channel);
            window.SimuNUS_API.onMessage(channel, (data) =>
              msg_forward_functions[source](channel, data)
            );
          } else {
            console.warn("Invalid source:", source);
            return;
          }
        },
      };
      if (
        window.SimuNUS_API.unity_embedded_mode === "iframe" ||
        window.SimuNUS_API.desktop_embedded_mode === "iframe"
      ) {
        window.addEventListener("message", (event) => {
          const channel = event.data?.channel;
          let handled = false;
          if (typeof channel !== "string") {
            console.warn("Received message from invalid channel:", channel);
            return;
          }
          if (channel in msg_callback) {
            msg_callback[channel](event.data?.data);
            handled = true;
          }
          //forward msg to ipcMain or other nodes
          for (const source in msg_forward_channels) {
            if (msg_forward_channels[source].includes(channel)) {
              msg_forward_functions[source](channel, event.data?.data);
              handled = true;
            }
          }
          if (!handled && window.SimuNUS_API._DEBUG) {
            console.warn(
              `Received from unknown channel ${channel} with msg ${event.data?.data}`
            );
          }
        });
      }
      for (const ch in msg_callback) {
        window.SimuNUS_API.onMessage(ch, msg_callback[ch]);
      }
      function showSimDesktop() {
        desktop_container.style.display = "block";
        desktop_container.focus();
      }
      function hideSimDesktop() {
        desktop_container.style.display = "none";
        unity_container.focus();
      }
      function sendTo(view, channel, msg, origin = "*") {
        //console.log(`send ${msg} over ${channel}`);
        if (view.tagName == "IFRAME") {
          view.contentWindow.postMessage(
            { channel: channel, data: msg },
            origin
          );
        } else if (view.tagName == "WEBVIEW") {
          view.send(channel, msg);
        } else {
          console.error(
            `Cannot seng msg to ${view} with tag name ${view.tagName}`
          );
        }
      }
    </script>
  </body>
</html>
